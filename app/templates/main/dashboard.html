{% extends "base.html" %} {% block content %}
<div class="fade-in">
  <!-- Welcome Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 fw-bold text-dark mb-1">
            Welcome back, {{ current_user.email.split('@')[0].title() }}
          </h1>
          <p class="text-muted mb-0">
            Manage your compliance documents securely and efficiently
          </p>
        </div>
        <div class="d-none d-md-block">
          <i
            class="bi bi-speedometer2 text-primary"
            style="font-size: 2.5rem"
          ></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-6 col-lg-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                <i
                  class="bi bi-files text-primary"
                  style="font-size: 1.5rem"
                ></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="fw-bold h4 mb-0">{{ total_documents }}</div>
              <div class="text-muted small">Total Documents</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-success bg-opacity-10 rounded-3 p-3">
                <i
                  class="bi bi-cloud-check text-success"
                  style="font-size: 1.5rem"
                ></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="fw-bold h4 mb-0">{{ total_documents }}</div>
              <div class="text-muted small">Stored Securely</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-info bg-opacity-10 rounded-3 p-3">
                <i
                  class="bi bi-shield-check text-info"
                  style="font-size: 1.5rem"
                ></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="fw-bold h4 mb-0">{{ ml_summary.avg_compliancy_rate }}%</div>
              <div class="text-muted small">ML Compliance Rate</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-lg-3 mb-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                <i
                  class="bi bi-files text-warning"
                  style="font-size: 1.5rem"
                ></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <div class="fw-bold h4 mb-0">{{ ml_summary.total_files }}</div>
              <div class="text-muted small">ML Analysis Files</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Row -->
  <div class="row">
    <!-- Upload Section -->
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0">
            <i class="bi bi-cloud-upload me-2 text-primary"></i>Upload Documents
          </h5>
        </div>
        <div class="card-body">
          <div class="text-center py-5">
            <div class="mb-4">
              <i
                class="bi bi-cloud-upload text-primary"
                style="font-size: 4rem; opacity: 0.7"
              ></i>
            </div>
            <h6 class="fw-bold mb-3">Upload Your Compliance Documents</h6>
            <p class="text-muted mb-4">
              Securely upload PDF and DOCX files to your compliance repository.
              All files are encrypted and stored in Azure Blob Storage.
            </p>

            <!-- Upload Form -->
            <form
              id="uploadForm"
              action="{{ url_for('upload.upload_file') }}"
              method="post"
              enctype="multipart/form-data"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />

              <div class="mb-3">
                <input
                  type="file"
                  class="form-control form-control-lg"
                  id="fileInput"
                  name="file"
                  accept=".pdf,.docx"
                  required
                />
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <button type="submit" class="btn btn-primary btn-lg px-4">
                  <i class="bi bi-upload me-2"></i>Upload Document
                </button>
                <a
                  href="{{ url_for('main.evidence_repository') }}"
                  class="btn btn-outline-primary btn-lg px-4"
                >
                  <i class="bi bi-folder2-open me-2"></i>View Repository
                </a>
              </div>
            </form>

            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Supported formats: PDF, DOCX • Maximum file size: 16MB
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Documents -->
    <div class="col-lg-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="bi bi-clock-history me-2 text-primary"></i>Recent
              Documents
            </h5>
            <a
              href="{{ url_for('main.evidence_repository') }}"
              class="btn btn-sm btn-outline-primary"
            >
              View All
            </a>
          </div>
        </div>
        <div class="card-body">
          {% if recent_documents %}
          <div class="list-group list-group-flush">
            {% for document in recent_documents %}
            <div class="list-group-item border-0 px-0">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-3">
                  {% if document.content_type == 'application/pdf' %}
                  <i
                    class="bi bi-file-earmark-pdf text-danger"
                    style="font-size: 1.5rem"
                  ></i>
                  {% else %}
                  <i
                    class="bi bi-file-earmark-word text-primary"
                    style="font-size: 1.5rem"
                  ></i>
                  {% endif %}
                </div>
                <div class="flex-grow-1 min-w-0" style="overflow: hidden">
                  <div
                    class="fw-medium"
                    title="{{ document.original_filename }}"
                    style="
                      white-space: nowrap;
                      overflow: hidden;
                      text-overflow: ellipsis;
                      max-width: 100%;
                    "
                  >
                    {{ document.original_filename }}
                  </div>
                  <small class="text-muted">
                    {{ document.uploaded_at | datetime_format('%b %d, %Y at
                    %I:%M %p') }} • {{ current_user.email.split('@')[0] }}
                  </small>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4">
            <i
              class="bi bi-inbox text-muted"
              style="font-size: 3rem; opacity: 0.5"
            ></i>
            <p class="text-muted mt-3 mb-0">No documents uploaded yet</p>
            <small class="text-muted"
              >Upload your first document to get started</small
            >
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ML Results Summary -->
  {% if ml_summary.total_files > 0 %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="bi bi-cpu me-2 text-primary"></i>ML Compliance Analysis
            </h5>
            <a href="{{ url_for('main.ml_results') }}" class="btn btn-sm btn-outline-primary">
              View Details
            </a>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-lg-8">
              <div class="row g-3">
                {% for file_summary in ml_summary.file_summaries[:4] %}
                <div class="col-md-6">
                  <div class="border rounded p-3 h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div class="flex-grow-1">
                        <h6 class="fw-bold mb-1">{{ file_summary.framework }}</h6>
                        <small class="text-muted">{{ file_summary.file_name[:30] }}...</small>
                      </div>
                      {% if file_summary.overall_status == 'Excellent' %}
                        <span class="badge bg-success">{{ file_summary.overall_status }}</span>
                      {% elif file_summary.overall_status == 'Good' %}
                        <span class="badge bg-info">{{ file_summary.overall_status }}</span>
                      {% elif file_summary.overall_status == 'Needs Attention' %}
                        <span class="badge bg-warning">{{ file_summary.overall_status }}</span>
                      {% else %}
                        <span class="badge bg-danger">{{ file_summary.overall_status }}</span>
                      {% endif %}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span class="fw-bold h5 mb-0">{{ file_summary.compliancy_rate }}%</span>
                      <small class="text-muted">{{ file_summary.total_requirements }} requirements</small>
                    </div>
                    <div class="progress mb-2" style="height: 6px;">
                      {% if file_summary.compliancy_rate >= 90 %}
                        <div class="progress-bar bg-success" style="width: {{ file_summary.compliancy_rate }}%"></div>
                      {% elif file_summary.compliancy_rate >= 70 %}
                        <div class="progress-bar bg-info" style="width: {{ file_summary.compliancy_rate }}%"></div>
                      {% elif file_summary.compliancy_rate >= 50 %}
                        <div class="progress-bar bg-warning" style="width: {{ file_summary.compliancy_rate }}%"></div>
                      {% else %}
                        <div class="progress-bar bg-danger" style="width: {{ file_summary.compliancy_rate }}%"></div>
                      {% endif %}
                    </div>
                    <div class="d-flex justify-content-between">
                      <small class="text-success">✓ {{ file_summary.complete_count }}</small>
                      <small class="text-warning">⏳ {{ file_summary.needs_review_count }}</small>
                      <small class="text-danger">✗ {{ file_summary.missing_count }}</small>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="col-lg-4">
              <div class="text-center">
                <div class="position-relative d-inline-block mb-3">
                  <svg width="150" height="150">
                    <circle cx="75" cy="75" r="60" fill="none" stroke="#e9ecef" stroke-width="15"/>
                    <circle cx="75" cy="75" r="60" fill="none" stroke="#28a745" stroke-width="15"
                            stroke-dasharray="{{ (ml_summary.avg_compliancy_rate / 100 * 377)|round }}, 377"
                            stroke-linecap="round" transform="rotate(-90 75 75)"/>
                  </svg>
                  <div class="position-absolute top-50 start-50 translate-middle text-center">
                    <div class="h3 fw-bold mb-0 text-primary">{{ ml_summary.avg_compliancy_rate }}%</div>
                    <small class="text-muted">Overall</small>
                  </div>
                </div>
                <div class="text-center">
                  <div class="row g-2">
                    <div class="col-4">
                      <div class="fw-bold text-success">{{ ml_summary.total_complete }}</div>
                      <small class="text-muted d-block">Complete</small>
                    </div>
                    <div class="col-4">
                      <div class="fw-bold text-warning">{{ ml_summary.total_needs_review }}</div>
                      <small class="text-muted d-block">Review</small>
                    </div>
                    <div class="col-4">
                      <div class="fw-bold text-danger">{{ ml_summary.total_missing }}</div>
                      <small class="text-muted d-block">Missing</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Quick Actions -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0">
            <i class="bi bi-lightning me-2 text-primary"></i>Quick Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6 col-lg-3">
              <a
                href="{{ url_for('main.evidence_repository') }}"
                class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3"
              >
                <i
                  class="bi bi-folder2-open mb-2"
                  style="font-size: 1.5rem"
                ></i>
                <span>Evidence Repository</span>
              </a>
            </div>
            <div class="col-md-6 col-lg-3">
              <a
                href="{{ url_for('main.adls_connection') }}"
                class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none"
              >
                <i class="bi bi-cloud mb-2" style="font-size: 1.5rem"></i>
                <span>ADLS Connection</span>
              </a>
            </div>
            <div class="col-md-6 col-lg-3">
              <a
                href="{{ url_for('main.gap_analysis') }}"
                class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none"
              >
                <i class="bi bi-graph-up mb-2" style="font-size: 1.5rem"></i>
                <span>Gap Analysis</span>
              </a>
            </div>
            <div class="col-md-6 col-lg-3">
              <a
                href="{{ url_for('main.audit_export') }}"
                class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3 text-decoration-none"
              >
                <i class="bi bi-download mb-2" style="font-size: 1.5rem"></i>
                <span>Audit Export</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // File upload validation
  document.getElementById("fileInput").addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
      const maxSize = 16 * 1024 * 1024; // 16MB
      const allowedTypes = [
        "application/pdf",
        "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
      ];

      if (file.size > maxSize) {
        alert("File size must be less than 16MB");
        this.value = "";
        return;
      }

      if (!allowedTypes.includes(file.type)) {
        alert("Only PDF and DOCX files are allowed");
        this.value = "";
        return;
      }
    }
  });

  // Auto-refresh ML data every 2 minutes
  {% if ml_summary.total_files > 0 %}
  setInterval(() => {
    fetch('{{ url_for("main.api_ml_summary") }}')
      .then(response => response.json())
      .then(data => {
        // Check if there are new results
        if (data.total_files !== {{ ml_summary.total_files }} || 
            data.last_updated !== '{{ ml_summary.last_updated.isoformat() }}') {
          
          // Show notification
          showToast('New ML analysis results available!', 'success');
          
          // Auto-refresh after 3 seconds
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        }
      })
      .catch(error => console.log('Auto-refresh check failed:', error));
  }, 120000); // 2 minutes

  function showToast(message, type = 'info') {
    const toastDiv = document.createElement('div');
    toastDiv.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
    toastDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toastDiv.setAttribute('role', 'alert');
    toastDiv.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-info-circle me-2"></i>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    
    document.body.appendChild(toastDiv);
    const toast = new bootstrap.Toast(toastDiv);
    toast.show();
    
    toastDiv.addEventListener('hidden.bs.toast', () => {
      toastDiv.remove();
    });
  }
  {% endif %}
</script>
{% endblock %}
